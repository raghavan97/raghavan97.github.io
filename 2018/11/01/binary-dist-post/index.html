<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Binary distributing a python package &middot; Python
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel='stylesheet' href='/css/terminal.css'>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Raghavan's Ramblings</p>
  </div>

  <nav class="sidebar-nav">

    
       <a class="sidebar-nav-item" href="/2018/11/01/binary-dist-post/">
                  Binary distributing a python package </a>

    
       <a class="sidebar-nav-item" href="/2017/07/01/logging-post/">
                  Python Logging </a>

    
       <a class="sidebar-nav-item" href="/2016/02/11/logger-post/">
                  Python Application Directory Structure </a>

    
       <a class="sidebar-nav-item" href="/2016/02/02/property-post/">
                  Property in Python Class </a>

    

  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2018. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Python</a>
            <small>Experiments</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Binary distributing a python package</h1>
  <span class="post-date">01 Nov 2018</span>
  <p>Python Packages are created by using <a href="https://github.com/raghavan97/python_programs/blob/master/packaging/setup.py">setup.py</a>. The <strong>setup.py</strong> describes all aspects of a package like name, version, description, files etc.</p>

<p>A <em>pure</em> python package is where the package contains of only python files. This is relatively easy to package and distribute since the python files by itself have no dependency on the Operating System.</p>

<p>A package that contains an Operating System dependent files is usually distributed using <strong>wheels</strong>. A <em>wheel</em> is generated by running the following command</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> python setup.py bdist_wheel
</code></pre></div></div>

<p>The output of the above command is a wheel file(.whl extension) generated under dist directory. The generated wheel file name contains many details.</p>

<p>A sample wheel file name is minty-0.0.4-cp27-cp27mu-linux_x86_64.whl</p>

<table>
  <thead>
    <tr>
      <th>Package name</th>
      <th>version tag</th>
      <th>py tag</th>
      <th>abi tag</th>
      <th>os tag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>minty</td>
      <td>0.0.4</td>
      <td>cp27</td>
      <td>cp27mu</td>
      <td>linux_x86_64</td>
    </tr>
  </tbody>
</table>

<p>For having a single wheel file to cater to all the variants of linux, a os tag of <em>manylinux1</em> is used.</p>

<p>To generate a wheel file for the <em>manylinux1</em> , we need to generate the wheel file using a special docker container available at <strong>quay.io/pypa/manylinux1_x86_64</strong>.</p>

<p>This docker container allows us to generate 2 wheels one for the narrow unicode(abi tag-cp27m) and wide unicode (abi tag-cp27mu)</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker run <span class="nt">-it</span> <span class="nt">-v</span><span class="nv">$PWD</span>:/src quay.io/pypa/manylinux1_x86_64
</code></pre></div></div>
<p>once inside the container, compile the sources, build the shared library and generate the wheels using the python in the container. A source distribution (sdist) is also built for the operating systems where the wheels are not present</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">cd</span> /src
<span class="gp">$</span> <span class="nb">cd </span>minty/mstplib
<span class="go">
</span><span class="gp">$</span> make clean_build
<span class="go">rm -f libmyextn.so csrc.o
make libmyextn.so
make[1]: Entering directory `/src/minty/mstplib'
gcc -fPIC -c csrc.c
gcc -shared csrc.o -lpthread -o libmyextn.so
make[1]: Leaving directory `/src/minty/mstplib'

</span><span class="gp">$</span> <span class="nb">cd</span> /src
<span class="gp">$</span> /opt/_internal/cpython-2.7.15-ucs4/bin/python setup.py bdist_wheel
<span class="go">running bdist_wheel
running build
running build_py
creating build
creating build/lib.linux-x86_64-2.7
creating build/lib.linux-x86_64-2.7/minty
</span><span class="c">...
...
</span><span class="go">
</span><span class="gp">$</span> /opt/_internal/cpython-2.7.15-ucs2/bin/python setup.py bdist_wheel
<span class="go">running bdist_wheel
running build
running build_py
creating build
creating build/lib.linux-x86_64-2.7
creating build/lib.linux-x86_64-2.7/minty
</span><span class="c">...
...
</span><span class="gp">$</span> /opt/_internal/cpython-2.7.15-ucs2/bin/python setup.py sdist
<span class="go">running sdist
running egg_info
writing requirements to minty.egg-info/requires.txt
writing minty.egg-info/PKG-INFO
writing top-level names to minty.egg-info/top_level.txt
writing dependency_links to minty.egg-info/dependency_links.txt
reading manifest file 'minty.egg-info/SOURCES.txt'
writing manifest file 'minty.egg-info/SOURCES.txt'
</span><span class="c">...
...
</span><span class="go">
</span></code></pre></div></div>

<p>The python in ucs4 creates a wheel minty-0.0.4-cp27-cp27<strong>mu</strong>-linux_x86_64.whl
The python in ucs2 creates a wheel minty-0.0.4-cp27-cp27<strong>m</strong>-linux_x86_64.whl</p>

<p>These wheels cannot be uploaded as is to pypi for distribution. They need to be checked and repaired by a tool <strong>auditwheel</strong> with respect to third-party external dependencies.</p>

<p>auditwheel is installed in a python3 environment using pip install auditwheel.  There are 2 auditwheel commands that can be used,  <strong>show</strong>  and <strong>repair</strong>. The <em>show</em> command tells us if there are any external versioned symbols.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> pip <span class="nb">install </span>auditwheel
<span class="go">Collecting auditwheel
  Using cached https://files.pythonhosted.org/packages/ac/c8/6b5e135684b8617eff1c2ffe6ac509837de904b852df682d1cd1c15235e8/auditwheel-1.9.0-py3-none-any.whl
</span><span class="c">...
...
</span><span class="go">Installing collected packages: auditwheel
Successfully installed auditwheel-1.9.0

</span><span class="gp">$</span> auditwheel show minty-0.0.4-cp27-cp27mu-linux_x86_64.whl 
<span class="go">minty-0.0.4-cp27-cp27mu-linux_x86_64.whl is consistent with the
following platform tag: "manylinux1_x86_64".

The wheel references external versioned symbols in these system-
provided shared libraries: libpthread.so.0 with versions
{'GLIBC_2.2.5'}, libc.so.6 with versions {'GLIBC_2.2.5'}

The following external shared libraries are required by the wheel:
{
    "libc.so.6": "/lib/x86_64-linux-gnu/libc-2.23.so",
    "libpthread.so.0": "/lib/x86_64-linux-gnu/libpthread-2.23.so"
}

</span><span class="gp">$</span> auditwheel repair minty-0.0.4-cp27-cp27mu-linux_x86_64.whl 
<span class="go">Repairing minty-0.0.4-cp27-cp27mu-linux_x86_64.whl
Previous filename tags: linux_x86_64
New filename tags: manylinux1_x86_64
Previous WHEEL info tags: cp27-cp27mu-linux_x86_64
New WHEEL info tags: cp27-cp27mu-manylinux1_x86_64

</span></code></pre></div></div>

<p>The distribution of python packages usually happens by uploading to pypi.org. For uploading a package to pypi.org, an account has to create by registering <a href="https://pypi.org/account/register/">here</a>.</p>

<p>After the registration, the uploading is done by using a utility called <strong>twine</strong>. We supply the list of the files to be uploaded on the command line. Typically the ‘*.whl’ files and the source distribution minty-*.tar.gz, generated by python setup.py sdist</p>

<p><em>twine</em> uses a file <strong>.pypirc</strong> in the home directory that contains the user name and password that were used during the registration above.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">cat</span> ~/.pypirc 
<span class="go">[distutils]
index-servers =
  pypi

[pypi]
username: xxxxx
password: yyyyyyyyy

</span><span class="gp">$</span> twine upload <span class="nt">-r</span> pypi dist/wheelhouse/<span class="k">*</span>.whl dist/minty-<span class="k">*</span>.tar.gz
</code></pre></div></div>
<p><em>twine</em> can be installed in a python3 environment and used to upload packages which are in python2 environment also.</p>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2017/07/01/logging-post/">
            Python Logging
            <small>01 Jul 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/02/11/logger-post/">
            Python Application Directory Structure
            <small>11 Feb 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/02/02/property-post/">
            Property in Python Class
            <small>02 Feb 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

        
      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
