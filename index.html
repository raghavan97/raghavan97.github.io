<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Python &middot; Experiments
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel='stylesheet' href='/css/terminal.css'>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Raghavan's Ramblings</p>
  </div>

  <nav class="sidebar-nav">

    
       <a class="sidebar-nav-item" href="/2017/07/01/logging-post/">
                  Python Logging </a>

    
       <a class="sidebar-nav-item" href="/2016/02/11/logger-post/">
                  Python Application Directory Structure </a>

    
       <a class="sidebar-nav-item" href="/2016/02/02/property-post/">
                  Property in Python Class </a>

    

  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2018. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Python</a>
            <small>Experiments</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/07/01/logging-post/">
        Python Logging
      </a>
    </h1>

    <span class="post-date">01 Jul 2017</span>

    <p>Python`s logging module is very versatile and very helpful for debugging issues in Software.This article examines some of the basic concepts of logging.</p>

<h2 id="source-code-organization">Source Code Organization</h2>

<p>There are 3 modules in the source code <a href="https://github.com/raghavan97/python_programs/blob/master/logging_example/module1" target="_blank">module1</a>, <a href="https://github.com/raghavan97/python_programs/blob/master/logging_example/module2" target="_blank">module2</a>, <a href="https://github.com/raghavan97/python_programs/blob/master/logging_example/module3" target="_blank">module3</a> . In main.py, we call functions from module1, module2. This would prove some of the concepts in logging module.</p>

<p><img src="/images/logging-tree.png" alt="hi" class="inline" /></p>

<h2 id="concepts">Concepts</h2>

<p>The root logger is configured by using logging.basicConfig call. We can specify the format of a log message and also the logging level. This configuration is done only once in the code. It is mandated to call basicConfig() before you make the first call using the logger.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">format_string</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'</span><span class="si">%(asctime)</span><span class="s">s:</span><span class="si">%(name)</span><span class="s">s:</span><span class="si">%(levelname)</span><span class="s">s:'</span>
    <span class="s">'</span><span class="si">%(filename)</span><span class="s">s:</span><span class="si">%(lineno)</span><span class="s">d:</span><span class="si">%(funcName)</span><span class="s">s:</span><span class="si">%(module)</span><span class="s">s:</span><span class="si">%(message)</span><span class="s">s'</span>
<span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">format_string</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span></code></pre></figure>

<p>After the root logger is configured , all the loggers would use the same format and logging level by default.</p>

<p>When you want to debug a module you might want to increase the logging level for that module. This is done by configuring the logger of that module. This is applicable only to that module.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span></code></pre></figure>

<p>The <a href="https://github.com/raghavan97/python_programs/blob/master/logging_example/module3/main.py" target="_blank">main.py</a> provides the main entry point for the project. It initializes the <em>root</em> logger. It also has a few log messages to demonstrate the logging at different levels. It calls a function f1 in module m1 and a function f2 from m2.</p>

<h2 id="program-execution-and-output">Program Execution and Output</h2>

<p>The log messages indicate the time, severity, and also the origin of the message in terms of the source file and line number as follows</p>

<p><img src="/images/logging-messages.png" alt="hi" class="inline" /></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="mi">2017</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">15</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">929</span><span class="p">:</span><span class="n">module1</span><span class="o">.</span><span class="n">m1</span><span class="p">:</span><span class="n">CRITICAL</span><span class="p">:</span><span class="n">m1</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="n">f1</span><span class="p">:</span><span class="n">m1</span><span class="p">:</span><span class="n">This</span> <span class="ow">is</span> <span class="n">CRITICAL</span> <span class="n">message</span> <span class="k">from</span> <span class="n">m1</span><span class="p">,</span><span class="n">f1</span></code></pre></figure>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/02/11/logger-post/">
        Python Application Directory Structure
      </a>
    </h1>

    <span class="post-date">11 Feb 2016</span>

    <p>One of the things that we need to get right for a python application is the way the project files are organized.</p>

<p>A correct directory structure makes it easier for</p>
<ul>
  <li>importing modules within the project</li>
  <li>logging messages in the logfile more meaningfully</li>
  <li>packaging and installation</li>
</ul>

<p>This blog is about a directory structure that works well on the above counts.</p>

<h2 id="project-structure">Project Structure</h2>

<p>A project can consist of multiple python modules. Each module might have one or more python source files. A sample project for demonstrating the proposed directory structure is shown below as the output of <strong>tree</strong> command.</p>

<p><img src="/images/dir.png" alt="hi" class="inline" /></p>

<p>The project contains the following directories and files</p>

<ul>
  <li>The sources of the project are under a directory <em>my_proj</em>. Incidentally <em>my_proj</em> is also a module.</li>
  <li>There are 2 modules <em>m1</em> and <em>m2</em> within <em>my_proj</em> that contain a source file each.</li>
  <li>A <em>setup.py</em> that helps create a pip installable package is at the root of directory tree</li>
  <li>A script <em>my_app</em> residing at the root of directory tree. <em>my_app</em> comes up in the PATH of the user after pip install for starting the application.</li>
</ul>

<p>The <a href="https://github.com/raghavan97/projdir/blob/master/my_proj/main.py">main.py</a> provides the main entry point for the project. It initializes the <em>root</em> logger. It also has a few log messages to demonstrate the logging at different levels. It calls a function in module m1. The directory structure helps the importing of function in any of the modules using project name, module name and source file name as follows</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">my_proj.m1.m1_src</span> <span class="kn">import</span> <span class="n">m1f</span></code></pre></figure>

<p>The <a href="https://github.com/raghavan97/projdir/blob/master/my_proj/m1/m1_src.py">m1-src.py</a> shows how we can change the logging level in any of the source file and log messages. There is a call to a function <em>m2f</em> from a different module <em>m2</em> by using the import statement as explained above.</p>

<p>In <a href="https://github.com/raghavan97/projdir/blob/master/myapp">myapp</a> , we have a script to start the application. Observe that it does not have an extension in the file name. It merely imports the main entry point from <em>my_proj/main</em>  and invokes it. The import statement follows the same convention as explained above.</p>

<p>In <a href="https://github.com/raghavan97/projdir/blob/master/setup.py">setup.py</a> we specify <em>my_app</em> as the script that starts the application. After the package is pip installed <em>my_app</em> comes up in the PATH and can be used to start the application. In setup.py , we also specify all the packages in the project <em>my_proj</em>, <em>my_proj.m1</em> and <em>my_proj.m2</em></p>

<h2 id="build-install-and-execute">Build, Install and Execute</h2>

<p>Here is how we build the package, install it and run the app.</p>

<p><img src="/images/packaging.png" alt="hi" class="inline" /></p>

<p>The log messages indicate the time, severity, and also the origin of the message in terms of the source file and line number as follows</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="mi">2017</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">14</span> <span class="mi">07</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span><span class="mi">091</span><span class="p">:</span><span class="n">CRITICAL</span><span class="p">:</span><span class="n">my_proj</span><span class="o">.</span><span class="n">m1</span><span class="o">.</span><span class="n">m1_src</span><span class="p">:</span><span class="mi">8</span><span class="p">:[</span><span class="n">message</span> <span class="n">content</span><span class="p">]</span></code></pre></figure>

<p>The source file, <em>my_proj.m1.m1_src</em> is indicated in the regular python dotted notation of module and source file. The line number <em>8</em> is the next field in the log message.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/02/02/property-post/">
        Property in Python Class
      </a>
    </h1>

    <span class="post-date">02 Feb 2016</span>

    <p>Recently we came across an interesting issue in our python project.</p>

<p>A class was instantiated with a particular value given to a instance variable. A few user actions later, an unexpected value of the instance variable was found. The symptoms ended there.</p>

<p>An initial attempt of trying to track the assignment of instance variable by code inspection was getting hard because</p>
<ul>
  <li>There were a number of places in the code base where the variable was getting assigned</li>
  <li>Most of the assignments were from other variables in the code.</li>
</ul>

<p>We looked for <a href="https://sourceware.org/gdb/onlinedocs/gdb/Set-Watchpoints.html">watch point</a> support in the python debugger (pdb) that could have simplified in catching the suspect. Unfortunately, pdb did not have watch point support. We did a little bit of googling around, to find other python debuggers with watch point support. The search did not yield any familiar python debuggers having watch point support.</p>

<p>We discussed a few ways of catching the culprit. The one that I am going to show you now caught my attention, since it was clean and smart.</p>

<h2 id="problem">Problem</h2>

<p>Here is the simulation of the same problem in a small piece of code.</p>

<p>We have a class <strong>BankCustomer</strong>, which has 3 attributes <em>name</em>, <em>id</em> and <em>balance</em>. An instance of BankCustomer is created with an initial value of the <em>balance</em> as 10000. The value of balance has been changed many times to simulate the assignments in different modules.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">inspect</span>

<span class="k">class</span> <span class="nc">BankCustomer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cust_id</span><span class="p">,</span> <span class="n">balance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cust_id</span> <span class="o">=</span> <span class="n">cust_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">balance</span>


<span class="n">c1</span> <span class="o">=</span> <span class="n">BankCustomer</span><span class="p">(</span><span class="s">'Amit'</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">15000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">25000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">65000</span></code></pre></figure>

<p>The idea is to catch the place where an assignment of a specific unacceptable value takes place. In this example, 5000 is an unacceptable value for balance.</p>

<h2 id="solution">Solution</h2>

<p>The way we solve this problem is</p>

<ul>
  <li>Make <em>balance</em> a property of the class</li>
  <li>In the property setter, we print the caller branching on the condition of interest</li>
</ul>

<p>We make use of the <a href="https://docs.python.org/2/library/inspect.html">inspect</a> module <strong>stack()</strong> call to get the caller information.</p>

<p>The following shows the modified code for solving the issue.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">inspect</span>

<span class="k">class</span> <span class="nc">BankCustomer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cust_id</span><span class="p">,</span> <span class="n">balance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cust_id</span> <span class="o">=</span> <span class="n">cust_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_balance</span> <span class="o">=</span> <span class="n">balance</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_balance</span>

    <span class="o">@</span><span class="n">balance</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_balance</span> <span class="o">==</span> <span class="mi">5000</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">frame</span><span class="p">,</span>
                <span class="n">filename</span><span class="p">,</span>
                <span class="n">line_num</span><span class="p">,</span> 
                <span class="n">func</span><span class="p">,</span> 
                <span class="n">source_code</span><span class="p">,</span>
                <span class="n">source_index</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">source_code</span><span class="p">[</span><span class="n">source_index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s">'assigned at {}:{} code="{}"'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span><span class="n">line_num</span><span class="p">,</span> <span class="n">code</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_balance</span> <span class="o">=</span> <span class="n">value</span>


<span class="n">c1</span> <span class="o">=</span> <span class="n">BankCustomer</span><span class="p">(</span><span class="s">'Amit'</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">15000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">25000</span>
<span class="n">c1</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">65000</span></code></pre></figure>

<p>We run the example. We can see a print that identifies the culprit. The print shows the <em>next executable statement</em> after the unacceptable assignment.</p>

<div class="terminal">
  <nav>
    <a href="#" class="close">close</a>
    <a href="#" class="minimize">minimize</a>
    <a href="#" class="deactivate">deactivate</a>
  </nav>
  <h3 class="title">Terminal</h3>
  <pre>
<span class="command">python example.py</span>
<span class="output">assigned at try.py:38 code=&quot;c1.balance = 15000&quot;</span>
  </pre>
</div>

  </div>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Older</span>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>


        
      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
